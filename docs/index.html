<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Mitchell Hitchcock" />


<title>Tool for identifing replicate field study locations</title>

<script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/simplex.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="site_libs/leaflet-1.3.1/leaflet.js"></script>
<link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="site_libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="site_libs/leaflet-binding-2.0.3/leaflet.js"></script>
<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="site_libs/datatables-binding-0.10/datatables.js"></script>
<link href="site_libs/dt-core-1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="site_libs/dt-core-1.10.19/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="site_libs/dt-core-1.10.19/js/jquery.dataTables.min.js"></script>
<link href="site_libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
<script src="site_libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="site_libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
<script src="site_libs/selectize-0.12.0/selectize.min.js"></script>
<link href="site_libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="site_libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 41px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h2 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h3 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h4 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h5 {
  padding-top: 46px;
  margin-top: -46px;
}
.section h6 {
  padding-top: 46px;
  margin-top: -46px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">R Data Science Final Project</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Tool for identifing replicate field study locations</h1>
<h3 class="subtitle">Demonstrated with Erie County brownfields</h3>
<h4 class="author">Mitchell Hitchcock</h4>

</div>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Replicated experiments are well known to have the highest power for statistical inference. However, this has rarely been properly implemented in field studies and numerous techniques have been devised to alleviate this challenge while avoiding psuedoreplication (Eberhardt and Thomas 1991). Due to the power (lower typeII error) of large replicate studies it would be desirable to develop a method for conducting such studies in field experiments so as to derive stronger inferences. Higher power is of equal interest to Bayesian analysis as it is to frequentest but discussion of either is outside the scope of this work save that it benefits all. The purpose of this project is to develop a tool for alleviating the first step which is identifying plausible replicate sites by using existing locations. It is possible to deal with uncontrolled variables through large numbers of replicates but the more uncontrolled and higher variation the variables are the more replicates are needed. This tool uses the large amounts of environmental data widely available to filter through locations and identify a desired number of replicates which are most similar given a set of variables. This tool is designed to be dynamic by allowing for multiple spatial data sets to be imported and desired variables to be filtered for.</p>
</div>
<div id="materials-and-methods" class="section level1">
<h1>Materials and methods</h1>
<p>Datasets:</p>
<p><a href="http://gis.ny.gov/gisdata/fileserver/?DSID=1300&amp;file=Erie-Tax-Parcels-Centroid-Points-SHP.zip">Erie County tax parcels</a></p>
<p><a href="https://data.ny.gov/api/views/c6ci-rzpg/rows.csv?accessType=DOWNLOAD&amp;sorting=true%22,%22data/points.csv">NYS Brownfields</a></p>
<p>These datasets were chosen to deomnstrate this tool becuase they are readily available and are focus locally. The tax parcels data allows us to determine property ownsership, acreage, value, contact information, and other attributes. A better option that this point file is a shape file of the parcels which is available upon request from the county. A shape file would allow more accurate attribution of other variables such as soil and climate. The brownfields data is chosen for demonstrations of how this tool could be used to identify potential brownfields with similar enough variables to allow use as replicates in related studies. Additoinal data could come from USDA, USGS, NOAA, and NASA depending on variables of interest.</p>
<p>Shiny code (in progress version at <a href="https://mitchhitch.shinyapps.io/prjkt/" class="uri">https://mitchhitch.shinyapps.io/prjkt/</a>)</p>
<pre class="r"><code>##render is reactive



library(shiny)
library(leaflet)
library(dplyr)
library(tools)
library(sf)
library(sp)
library(tidyverse)
library(doParallel)
library(nngeo)#st_nn
library(stringr)



ui &lt;- fluidPage(
    #Make into tabs
    navbarPage(
        &quot;Best Rep&quot;,
        tabPanel(&quot;Step 1&quot;,
                 #Upload file1
                 h2(&#39;Upload your files&#39;),
                 textOutput(&quot;at least one must be a .shp file (.csv with headers and .shp only&quot;),
                 fileInput(&#39;file1&#39;, &#39;This must be a shp&#39;),
                 #upload file2
                 fileInput(&#39;file2&#39;, &#39;Choose second file&#39;),
                 #select number of reps desired
                 numericInput(&quot;n_reps&quot;,&quot;How many replicates would you like?&quot;,value=30,min=2,max=300)
                 ),
        
        tabPanel(&quot;Step 2&quot;,
                 
                 #Select which columns you care about backend in server
                 uiOutput(&quot;SelectCols1&quot;),
                 uiOutput(&quot;SelectCols2&quot;)
                 
                 
                 ),
        tabPanel(&quot;Step 3&quot;,
                 #Fixed variables within the columns
                 
                 #Run Button
                 actionButton(&quot;RUN&quot;, &quot;Click and walk away&quot;)
                 ),
        tabPanel(&quot;Results&quot;,
                 #leaflet
                 #Table
                 leafletOutput(&quot;bestmap&quot;)

                 
                 )
    )
    
    
    
    
)

        

server &lt;- function(input, output,session) {
    options(shiny.maxRequestSize=30000*1024^2)
    
    #################funcz
    #####This should be run AFTER columns have been trimmed
    TransCoord_csv&lt;-function(File1,FileX,FileX_Lon=&quot;Longitude&quot;,FileX_Lat=&quot;Latitude&quot;,FileX_crs=4326){
        
        FileX&lt;-st_as_sf(FileX,coords=c(FileX_Lon,FileX_Lat)) %&gt;% 
            st_set_crs(FileX_crs) %&gt;% 
            st_transform(st_crs(File1)) %&gt;% 
            st_crop(st_bbox(File1))
        FileX
        
    }
    
    
    ### Join all files into 1 sf ONLY run afer TransCoord_csv or st_transform for shape files.
    All_F&lt;-function(File1,File2){
        # OtherF&lt;-list(...)
        # countF&lt;-length(OtherF)
        MainF&lt;-File1
        # for(i in 1:countF){
        #     MainF=st_join(OtherF[[1]],MainF,join=st_nn,k=1,maxdist=500) %&gt;% 
        #         aggregate( by=list(.[,1]),FUN=unique,do_union=TRUE,join = st_intersects)
        # }
        File2&lt;-File2
        MainF=st_join(File2,MainF,join=st_nn,k=1,maxdist=500) %&gt;% 
            aggregate( by=list(.$Program.Facility.Name),FUN=unique,do_union=TRUE,join = st_intersects)
        MainF
        
    }
    
    ###runs the itterative ranking
    Run.score&lt;-function(shapeobj_trim,number){
        number=number
        foreach(r=1:nrow(shapeobj_trim))%dopar%{
            x&lt;-shapeobj_trim %&gt;% 
                select(-geometry)
            x_ret&lt;-shapeobj_trim
            for(i in 1:nrow(x)){
                
                x_ret[i,&quot;Score&quot;]&lt;-score.calc(x[r,],x[i,])
                
            }
            
            x_ret&lt;-head(x_ret[order(x_ret$Score),],n=number)
            x_ret
        }
    }
    
    ###This ranks the similarit of rows
    score.calc&lt;-function(rowprime,rowtest){
        
        colscore&lt;-vector(length=length(rowprime))
        for(i in 1:ncol(rowprime)){
            prime&lt;-rowprime[i]
            if(is.list(prime)){
                prime&lt;-unlist(prime)
            }
            test&lt;-rowtest[i]
            if(is.list(test)){
                test&lt;-unlist(test)
            }
            if(length(prime)&gt;1||length(test)&gt;1){
                colscore[i]&lt;-as.double(length(c(
                    setdiff(prime,test),
                    setdiff(test,prime)))
                )
                
            }
            else if(is.double(prime)||is.numeric(prime)){
                colscore[i]&lt;-as.double(abs((prime-test)/(prime+test)))
                
            }
            else if(is.factor(prime)||is.character(prime)){
                if(prime==test){
                    colscore[i]&lt;-0
                    
                }
                else{
                    colscore[i]&lt;-1
                    
                }
            }
            else 
                colscore[i]&lt;-NA
        }
        
        return(sum(colscore))
    }
    
    
    ###Select best sets of sites
    Out_best&lt;-function(possible_n){
        #Determine min possible value for sets
        minimum&lt;-foreach(i=1:length(possible_n),.combine=c)%dopar%{
            sum(possible_n[[i]]$Score)
        } %&gt;% 
            min()
        #Select sets with min possible value
        best&lt;-foreach(i=1:length(possible_n))%dopar%{
            if(sum(possible_n[[i]]$Score)==minimum){
                return(possible_n[[i]])
            }
        } %&gt;% 
            compact()
        
        best
        
    }
    ##########################3
    ###File1
    data1&lt;- reactive({
        withProgress(message = &#39;Loading Files&#39;, value = 0, {
            n&lt;-4
            incProgress(1/n, detail = paste(&quot;Uploading&quot;, 1))
            filein &lt;- input$file1
            if (is.null(filein)) { 
                return() 
            } 
            else if (file_ext(filein$datapath)==&quot;csv&quot;){
                incProgress(1/n, detail = paste(&quot;Reading csv&quot;, 2))
                data = read.csv(file=filein$datapath)
                incProgress(1/n, detail = paste(&quot;csv Read&quot;, 3))
                return(data)
            }
            else if (!is.null(filein)){
                incProgress(1/n, detail = paste(&quot;Unzipping&quot;, 2))    
                prevWD &lt;- getwd()
                unlink(&quot;unzipped&quot;, recursive = TRUE)
                dir.create(&quot;unzipped&quot;)
                tempdir &lt;- &quot;unzipped&quot;
                unzip(filein$datapath, exdir = tempdir)
                setwd(tempdir)
                if(length(list.dirs(recursive=FALSE))&gt;0){
                    setwd(list.dirs(recursive = FALSE))
                }
                else{
                    print(&quot;in correct wd&quot;)
                }
                shpName &lt;- list.files()[grep(list.files(),pattern=&quot;*.shp&quot;)[1]]
                incProgress(1/n, detail = paste(&quot;Reading shape file&quot;, 3))
                shpFile &lt;- st_read(shpName)
                return(shpFile)
            } 
            else {
                return()
            }
            incProgress(1/n, detail = paste(&quot;Read&quot;, 4))
        })
        
    })
    
    
    ###File2
    data2 &lt;- reactive({
        withProgress(message = &#39;Loading Files&#39;, value = 0, {
        n&lt;-4
            incProgress(1/n, detail = paste(&quot;Uploading&quot;, 1))
        filein &lt;- input$file2
        if (is.null(filein)) { 
            return() 
        } 
        else if (file_ext(filein$datapath)==&quot;csv&quot;){
            incProgress(1/n, detail = paste(&quot;Reading csv&quot;, 2))
            data = read.csv(file=filein$datapath)
            incProgress(1/n, detail = paste(&quot;csv Read&quot;, 3))
            return(data)
        }
        else if (!is.null(filein)){
            incProgress(1/n, detail = paste(&quot;Unzipping&quot;, 2))    
            prevWD &lt;- getwd()
            unlink(&quot;unzipped&quot;, recursive = TRUE)
            dir.create(&quot;unzipped&quot;)
            tempdir &lt;- &quot;unzipped&quot;
            unzip(filein$datapath, exdir = tempdir)
            setwd(tempdir)
            if(length(list.dirs(recursive=FALSE))&gt;0){
                setwd(list.dirs(recursive = FALSE))
            }
            else{
                print(&quot;in correct wd&quot;)
            }
            shpName &lt;- list.files()[grep(list.files(),pattern=&quot;*.shp&quot;)[1]]
            incProgress(1/n, detail = paste(&quot;Reading shape file&quot;, 3))
            shpFile &lt;- st_read(shpName)
            return(shpFile)
        } 
        else {
            return()
            }
        incProgress(1/n, detail = paste(&quot;Read&quot;, 4))
        })

    })
 
    ##This is just a demo table for File1
    # output$table_display &lt;- renderTable({
    #     f &lt;- data1()
    #     f &lt;- select(f, c(input$columns1)) #subsetting takes place here
    #     head(f)
    # })
    

    ###This allows for selecting desired columns
    ##File1
    output$SelectCols1 &lt;- renderUI({
        selectInput(&quot;columns1&quot;, &quot;Select Columns&quot;, choices= names(data1()),multiple = TRUE)
    })
    ##File2
    output$SelectCols2 &lt;- renderUI({
        selectInput(&quot;columns2&quot;, &quot;Select Columns&quot;, choices= names(data2()),multiple = TRUE)
    })
    
    
    
    RealRun&lt;-eventReactive(input$RUN,{ 
        withProgress(message = &#39;Running Comparison&#39;, value = 0, {
        # Number of steps
        n &lt;- 10
        
        req(input$columns1)
        req(input$columns2)
        number&lt;-input$n_reps
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 1))
        registerDoParallel(cores = 6)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 2))
        
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 3))
        
        data1_trim&lt;-select(data1(), input$columns1)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 4))
        rm(data1())
        data2_trim&lt;-select(data2(), input$columns2)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 5))
        rm(data2())
        data2_tran&lt;-TransCoord_csv(data1_trim,data2_trim)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 6))
        rm(data2_trim)
        data_ALL&lt;-All_F(data1_trim,data2_tran)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 7))
        rm(data1_trim,data2_tran)
        Ranked_list&lt;-Run.score(data_ALL,number)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 8))
        rm(data_ALL)
        best&lt;-Out_best(Ranked_list)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 9))
        rm(Ranked_list)
        first&lt;-st_transform(best[[1]],&#39;+proj=longlat +datum=WGS84&#39;)
        incProgress(1/n, detail = paste(&quot;Doing part&quot;, 10))
        
        first
        })
    })
    
    output$bestmap &lt;- renderLeaflet({
        
        leaflet() %&gt;% 
            addTiles() %&gt;% 
            addCircleMarkers(data = st_geometry(RealRun()), popup=first$Program.Facility.Name)
        
    })
    
    
    #observe( on button press run the script from the values in place or set defaults.)

    
}


shinyApp(ui = ui, server = server)</code></pre>
<p>Core Functions:</p>
<p>Transform crs and set bounding box to same area.</p>
<pre class="r"><code>TransCoord_csv&lt;-function(File1,FileX,FileX_Lon=&quot;Longitude&quot;,FileX_Lat=&quot;Latitude&quot;,FileX_crs=4326){
  
  FileX&lt;-st_as_sf(FileX,coords=c(FileX_Lon,FileX_Lat)) %&gt;% 
    st_set_crs(FileX_crs) %&gt;% 
    st_transform(st_crs(File1)) %&gt;% 
    st_crop(st_bbox(File1))
  FileX
  
}</code></pre>
<p>Join all uploaded files together.</p>
<pre class="r"><code>All_F&lt;-function(File1,...){
  OtherF&lt;-list(...)
  countF&lt;-length(OtherF)
  MainF&lt;-File1
  for(i in 1:countF){
    MainF=st_join(OtherF[[1]],MainF,join=st_nn,k=1,maxdist=500) %&gt;% 
      aggregate( by=list(.[,1]),FUN=unique,do_union=TRUE,join = st_intersects)
    
  }

}</code></pre>
<p>Rank all the rows based on each field. This function compares each row with every other row and gives a score on how similar they are. Currently factors are weihted as 1 the same or 0 different.</p>
<pre class="r"><code>score.calc&lt;-function(rowprime,rowtest){
  
  colscore&lt;-vector(length=length(rowprime))
  for(i in 1:ncol(rowprime)){
    prime&lt;-rowprime[i]
    if(is.list(prime)){
      prime&lt;-unlist(prime)
    }
    test&lt;-rowtest[i]
    if(is.list(test)){
      test&lt;-unlist(test)
    }
    if(length(prime)&gt;1||length(test)&gt;1){
      colscore[i]&lt;-as.double(length(c(
        setdiff(prime,test),
        setdiff(test,prime)))
      )
      
    }
    else if(is.double(prime)||is.numeric(prime)){
      colscore[i]&lt;-as.double(abs((prime-test)/(prime+test)))
      
    }
    else if(is.factor(prime)||is.character(prime)){
      if(prime==test){
        colscore[i]&lt;-0
        
      }
      else{
        colscore[i]&lt;-1
        
      }
    }
    else 
      colscore[i]&lt;-NA
  }
  
  return(sum(colscore))
}</code></pre>
<p>Itterate over every possible combination and combine into a list of each sites best matches. This is defined as the sites where their scores are the lowest when added together.</p>
<pre class="r"><code>Run.score&lt;-function(shapeobj_trim){
foreach(r=1:nrow(shapeobj_trim))%dopar%{
  x&lt;-shapeobj_trim %&gt;% 
    select(-geometry)
  x_ret&lt;-shapeobj_trim
  for(i in 1:nrow(x)){
    
    x_ret[i,&quot;Score&quot;]&lt;-score.calc(x[r,],x[i,])
    
  }
  
  x_ret&lt;-head(x_ret[order(x_ret$Score),],n=number)
  x_ret
}
}</code></pre>
<p>Select the best site combination (ties acceptable).</p>
<pre class="r"><code>Out_best&lt;-function(possible_n){
  #Determine min possible value for sets
minimum&lt;-foreach(i=1:length(possible_n),.combine=c)%dopar%{
  sum(possible_n[[i]]$Score)
} %&gt;% 
  min()
  #Select sets with min possible value
best&lt;-foreach(i=1:length(possible_n))%dopar%{
  if(sum(possible_n[[i]]$Score)==minimum){
    return(possible_n[[i]])
  }
} %&gt;% 
  compact()

best

}</code></pre>
</div>
<div id="results" class="section level1">
<h1>Results</h1>
<pre><code>##            used  (Mb) gc trigger  (Mb) max used  (Mb)
## Ncells  9199445 491.4   16902828 902.8 16902828 902.8
## Vcells 52993068 404.4   87793298 669.9 73094413 557.7</code></pre>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  4161442 222.3   18794468 1003.8  16902828  902.8
## Vcells 18701576 142.7  310326453 2367.7 350491082 2674.1</code></pre>
<pre><code>##           used  (Mb) gc trigger  (Mb)  max used   (Mb)
## Ncells 2035662 108.8    9622768 514.0  16902828  902.8
## Vcells 5274502  40.3   52064141 397.3 350491082 2674.1</code></pre>
<pre><code>##           used  (Mb) gc trigger  (Mb)  max used   (Mb)
## Ncells 2063739 110.3    7698215 411.2  16902828  902.8
## Vcells 5960722  45.5   41651313 317.8 350491082 2674.1</code></pre>
<pre><code>##           used  (Mb) gc trigger  (Mb)  max used   (Mb)
## Ncells 2064026 110.3    6158572 329.0  16902828  902.8
## Vcells 5969452  45.6   33321051 254.3 350491082 2674.1</code></pre>
<p><div id="htmlwidget-d1032303a2e7d97ee79a" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-d1032303a2e7d97ee79a">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"http://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addPolygons","args":[[[[{"lng":[-78.850348696527,-78.8518399360584,-78.8524728464799,-78.8509822344568,-78.850348696527],"lat":[42.835850508402,42.8354362767305,42.8366555111309,42.8370710089219,42.835850508402]}]],[[{"lng":[-78.8742312712122,-78.8742714844574,-78.8742760828933,-78.8746816558133,-78.8746362606389,-78.8742312712122],"lat":[42.8917135739818,42.8915858816253,42.8915718066814,42.8916424563213,42.8917838831788,42.8917135739818]}]],[[{"lng":[-78.853620626222,-78.8572719897961,-78.8574560800836,-78.8575362944484,-78.8539167098733,-78.853620626222],"lat":[42.8174385414618,42.8165394987941,42.8169438490282,42.8171977423925,42.8180889619015,42.8174385414618]}]],[[{"lng":[-78.8466631383938,-78.8470120521322,-78.8475025634362,-78.8475573102185,-78.8472048621051,-78.8466631383938],"lat":[42.8182275478176,42.8181427234527,42.819207475075,42.8193160257784,42.8194222944793,42.8182275478176]}]],[[{"lng":[-78.7478877655077,-78.7478897076244,-78.747910590837,-78.7484027411263,-78.7483929221766,-78.7483896208219,-78.7478877655077],"lat":[42.868927735314,42.868881148552,42.8683778555285,42.8683873285946,42.8687979482415,42.8689359728797,42.868927735314]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2,"smoothFactor":1,"noClip":false},["Buffalo Lakeside Commerce Park - Parcel 4","275 Franklin Street","Site III-8 Tecumseh Phase III Business Park","2424 Hamburg Turnpike","CMS Property Associates, LLC"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[42.8165394987941,42.8917838831788],"lng":[-78.8746816558133,-78.7478877655077]}},"evals":[],"jsHooks":[]}</script><div id="htmlwidget-d56cd0425df8c601e828" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d56cd0425df8c601e828">{"x":{"filter":"top","filterHTML":"<tr>\n  <td><\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"32.0072296124928\" data-max=\"36.9171974522293\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0.140000000596\" data-max=\"5.92000007629\" data-scale=\"12\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"0\" data-max=\"215\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"176.548771449498\" data-max=\"190.918403625488\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["60","6","39","4","35"],["Buffalo Lakeside Commerce Park - Parcel 4","275 Franklin Street","Site III-8 Tecumseh Phase III Business Park","2424 Hamburg Turnpike","CMS Property Associates, LLC"],[36.9171974522293,36.9171974522293,32.0072296124928,32.0072296124928,36.9171974522293],[4.69000005722,0.140000000596,5.92000007629,1.20000004768,0.610000014305],[[["cyanides(soluble cyanide salts)","lead"]],[["tetrachloroethene (PCE)","trichloroethene (TCE)"]],[["mercury","arsenic","PCB aroclor 1260","benzo(a)pyrene","dibenz[a,h]anthracene","benzo(a)anthracene","cadmium","benzo(b)fluoranthene","indeno(1,2,3-CD)pyrene"]],[["toluene","benzo(a)anthracene","indeno(1,2,3-CD)pyrene","ethylbenzene","benzene","xylene (mixed)","isopropylbenzene","naphthalene","chrysene","arsenic","1,2,4-TMB","n-propylbenzene","benzo(b)fluoranthene","1,3,5-trimethylbenzene","benzo(a)pyrene"]],[""]],[["ERP"],["BCP"],["BCP"],["BCP"],["HW"]],[9,9,9,9,9],[["J"],["J"],["J"],["J"],["A"]],["N ","C ","C ","A ","04"],[[[[-78.850348696527,42.835850508402],[-78.8518399360584,42.8354362767305],[-78.8524728464799,42.8366555111309],[-78.8509822344568,42.8370710089219],[-78.850348696527,42.835850508402]]],[[[-78.8742312712122,42.8917135739818],[-78.8742714844574,42.8915858816253],[-78.8742760828933,42.8915718066814],[-78.8746816558133,42.8916424563213],[-78.8746362606389,42.8917838831788],[-78.8742312712122,42.8917135739818]]],[[[-78.853620626222,42.8174385414618],[-78.8572719897961,42.8165394987941],[-78.8574560800836,42.8169438490282],[-78.8575362944484,42.8171977423925],[-78.8539167098733,42.8180889619015],[-78.853620626222,42.8174385414618]]],[[[-78.8466631383938,42.8182275478176],[-78.8470120521322,42.8181427234527],[-78.8475025634362,42.819207475075],[-78.8475573102185,42.8193160257784],[-78.8472048621051,42.8194222944793],[-78.8466631383938,42.8182275478176]]],[[[-78.7478877655077,42.868927735314],[-78.7478897076244,42.868881148552],[-78.747910590837,42.8683778555285],[-78.7484027411263,42.8683873285946],[-78.7483929221766,42.8687979482415],[-78.7483896208219,42.8689359728797],[-78.7478877655077,42.868927735314]]]],[0,194,203,209,215],[[176.640030472367],[187.891246795654],[178.846293979221],[176.548771449498],[190.918403625488]]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Program.Facility.Name<\/th>\n      <th>PRCP<\/th>\n      <th>ASSESSACRE<\/th>\n      <th>Contaminants<\/th>\n      <th>Program.Type<\/th>\n      <th>DEC.Region<\/th>\n      <th>Control.Code<\/th>\n      <th>Site.Class<\/th>\n      <th>geometry<\/th>\n      <th>Score<\/th>\n      <th>elev<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"autoWidth":true,"caption":"This is a table of the best matched locations and thier corresponding variables","columnDefs":[{"className":"dt-right","targets":[2,3,6,10,11]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script></p>
</div>
<div id="conclusions" class="section level1">
<h1>Conclusions</h1>
<p>Although this tool is in very early stages it is promising. The flexibility of this tool will allow it to go beyond the example given here. Another possible use in consideration is identifying locations in a greenhouse with least amount of wind, light, and temperature variability. A major drawback is that this code as it stands is computationally intensive and prohibitive for use on personal computers. A solution to this would be to optimize the algorithms and/or host on a server.</p>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>Eberhardt, L. L., and J. M. Thomas. 1991. Designing Environmental Field Studies. Ecological Monographs 61:53–73.</p>
<p><a href="https://data.ny.gov/" class="uri">https://data.ny.gov/</a></p>
<p><a href="http://gis.ny.gov/" class="uri">http://gis.ny.gov/</a></p>
</div>

<!-- give the footer some space -->
<br/>
<br/>

<footer id="site-footer">
  <div id="footer1">
  This website is a project for Adam Wilson's <a href="https://wilsonlab.io/GEO511"><i> Spatial Data Science (GEO511) </i></a>Course at the University at Buffalo
  </div>
  <div id="footer2">
  <a rel="license" property="http://creativecommons.org/ns#license"
  href="http://creativecommons.org/licenses/by/4.0/" ><img src="img/cc-by.svg" alt="cc-by"/></a> 
  </div>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>


</body>
</html>
